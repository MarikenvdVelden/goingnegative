---
title: 'Analyses'
author: 
output: 
  github_document:
    toc: yes
editor_options: 
  chunk_output_type: console
---

```{r "setup", include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.align = "center",
                      fig.path=('../../report/figures/'))
library(printr)
options(digits = 2)
library(rmarkdown)
library(here)
```

# Scripts
- [Required Packages &amp; Reproducibility](#required-packages-&amp;-reproducibility)
- [Analyses](#analyses)
  - [H1 Direct Effect of Journalistic Control on Negative Appeals](#H1-Direct-Effect-of-Journalistic-Control-on-Negative-Appeals)
  - [H2 Interaction Effect of Polls with Journalistic Control on Negative Appeals](#H2-Interaction-Effect-of-Polls-with-Journalistic-Control-on-Negative-Appeals)
  - [H3 Interaction Effect of Ideological Extremity with Journalistic Control on Negative Appeals](#H3-Interaction-Effect-of-Ideological-Extremity-with-Journalistic-Control-on-Negative-Appeals)
  - [H4 Interaction Effect of Issue Ownership with Journalistic Control on Negative Appeals](#H4-Interaction-Effect-of-Issue-Ownership-with-Journalistic-Control-on-Negative-Appeals)

# Required Packages &amp; Reproducibility
```{r "env", message=FALSE, warning=F}
rm(list=ls())
source(here("src/lib/functions.R"))
```

# Analyses
```{r "data for analyses"}
load(here("data/intermediate/cleaned_data.RData"))

df <- d %>%
  mutate(negative_appeal = ifelse(direction_appeal=="Negative Appeal",
                                  1,0)) %>%
  group_by(party, date) %>%
  summarise(negative_appeals = n(),
            polls1 = mean(poll_standing1, na.rm = T),
            polls2 = mean(poll_standing2, na.rm = T),
            polls3 = mean(poll_standing3, na.rm = T),
            polls4 = mean(poll_standing4, na.rm = T),
            polls5 = mean(poll_standing5, na.rm = T),
            polls6 = mean(poll_standing6, na.rm = T),
            polls7 = mean(poll_standing7, na.rm = T),
            polls8 = mean(poll_standing8, na.rm = T),
            polls9 = mean(poll_standing9, na.rm = T),
            io1 = mean(aio_percentage, na.rm = T),
            io2 = mean(cio_mean, na.rm = T),
            io3 = mean(cio_median, na.rm = T),
            io4 = mean(cio_sd, na.rm = T),
            ie1 = mean(ie_median_ches2017, na.rm = T),
            ie2 = mean(ie_mean_ches2017, na.rm = T),
            ie3 = mean(ie_median_ches2014, na.rm = T),
            ie4 = mean(ie_mean_ches2014, na.rm = T),
            ie5 = mean(ie_median_cmp2017, na.rm = T),
            ie6 = mean(ie_mean_cmp2017, na.rm = T),
            ie7 = mean(ie_median_cmp2012, na.rm = T),
            ie8 = mean(ie_mean_cmp2012, na.rm = T),
            ji1  = mean(journalistic_intervenience, na.rm = T),
            ji2 = sum(journalistic_intervenience),
            ji3 = ji2-ji1
            ) %>%
  mutate(opposition = ifelse(party == "VVD", 0,
                      ifelse(party == "PvdA", 0, 1)),
         new_party = ifelse(party == "FvD", 1, 0),
         ie3 = ifelse(party == "FvD", 0, ie3),
         ie4 = ifelse(party == "FvD", 0, ie4),
         ie7 = ifelse(party == "FvD", 0, ie7),
         ie8 = ifelse(party == "FvD", 0, ie8),
         group1 = ifelse(ji1<=.2, 0,
                  ifelse(ji1>.2 & ji1<=.5, 1, 2)),
         group2 = ifelse(ji2<=.5, 0,
                  ifelse(ji2>.5 & ji2<=3, 1, 2)),
         group3 = ifelse(ji3<=.5, 0,
                  ifelse(ji3>.5 & ji3<=3, 1, 2))) %>%
  ungroup()

df <- slide(data = df, Var = "negative_appeals", TimeVar = "date",
               GroupVar = "party", NewVar = "l_negative_appeal", 
            slideBy = -1)
```

## H1 Direct Effect of Journalistic Control on Negative Appeals
```{r "h1", fig.align="center", fig.height=8, fig.width=8}
h1 <- run_specs(df = df,
                      y = c("negative_appeals"),
                      x = c("ji1", "ji2", "ji3"),
                      controls = c("polls1","polls2","polls3","polls4",
                                  "polls5","polls6","polls7","polls8",
                                  "polls9",
                                  "ie1","ie2","ie3","ie4","ie5","ie6",
                                  "ie7","ie8",
                                  "io1","io2","io3","io4"),
                      model = "glmer_mv")

h1 %>%  
  mutate(id = 1:69,
         x = recode(x, 
                    `ji1` = "Daily Average",
                    `ji2` = "Daily Sum",
                    `ji3` = "Deviation from Daily Average")) %>%
  ggplot(aes(x = reorder(id, estimate),
             y = estimate,
             group = id,
             colour = x,
             ymin = conf.low,
             ymax = conf.high)) +
  geom_point() + geom_errorbar() +
  theme_minimal() +
  labs(x = "", y = "Estimates of Generalized Linear Mixed-Effects Poisson Model",
       title = "Effect of Journalistic Intervention on # Negative Appeals",
       subtitle = "Controlled for Standing in Polls, Ideological Extremity and Issue Ownership" ) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position="bottom",
        legend.title = element_blank()) +
  scale_color_viridis_d() +
  geom_hline(yintercept = 0, size = .2, linetype = "dashed") +
  guides(color=guide_legend(nrow=1,byrow=TRUE)) +
  coord_flip()
```

## H2 Interaction Effect of Polls with Journalistic Control on Negative Appeals
```{r "h2", fig.align="center", fig.height=8, fig.width=8}
h2_1 <- run_specs(df = df,
                  y = c("negative_appeals"),
                  x = c("polls1","polls2","polls3","polls4",
                                  "polls5","polls6","polls7","polls8",
                                  "polls9"),
                  controls = c("ie1","ie2","ie3","ie4","ie5","ie6",
                                  "ie7","ie8",
                                  "io1","io2","io3","io4"),
                  model = "glmer_mv",
                  subsets = list(group1 = unique(df$group1)))

h2_2 <- run_specs(df = df, 
                  y = c("negative_appeals"),
                  x = c("polls1","polls2","polls3","polls4",
                                  "polls5","polls6","polls7","polls8",
                                  "polls9"),
                  controls = c("ie1","ie2","ie3","ie4","ie5","ie6",
                                  "ie7","ie8",
                                  "io1","io2","io3","io4"),
                  model = "glmer_mv",
                  subsets = list(group1 = unique(df$group2)))

h2_3 <- run_specs(df = df,
                  y = c("negative_appeals"),
                  x = c("polls1","polls2","polls3","polls4",
                                  "polls5","polls6","polls7","polls8",
                                  "polls9"),
                  controls = c("ie1","ie2","ie3","ie4","ie5","ie6",
                                  "ie7","ie8",
                                  "io1","io2","io3","io4"),
                  model = "glmer_mv",
                  subsets = list(group1 = unique(df$group3)))

h2_1 <- h2_1 %>% 
  mutate(id = "Daily Average",
         id2 = 1:dim(h2_1)[1]) %>%
  filter(subsets != "all")
h2_2 <- h2_2 %>% 
  mutate(id = "Daily Sum ",
         id2 = 1:dim(h2_2)[1]) %>%
  filter(subsets != "all")
h2_3 <- h2_3 %>% 
  mutate(id = "Deviation from Daily Average",
         id2 = 1:dim(h2_3)[1]) %>%
  filter(subsets != "all")

h2 <- h2_1 %>% 
  add_row(h2_2) %>% 
  add_row(h2_3) %>%
  mutate(subsets = recode(subsets,
                          `group1 = 0` = "Journalistic Intervention: Low",
                          `group1 = 1` = "Journalistic Intervention: Medium",
                          `group1 = 2` = "Journalistic Intervention: High"),
         subsets = factor(subsets,
                          levels = c("Journalistic Intervention: Low", "Journalistic Intervention: Medium", "Journalistic Intervention: High")))

h2 %>%  
  ggplot(aes(y = reorder(id2, estimate),
             x = estimate,
             group = subsets,
             colour = subsets,
             xmin = conf.low,
             xmax = conf.high)) +
  geom_point() + geom_errorbar() +
  facet_grid(id~subsets, scales = "free") +
  labs(y = "", x = "Estimates of Generalized Linear Mixed-Effects Poisson Model",
       title = "Effect of Standing in the Polls on # Negative Appeals",
       subtitle = "Controlled for Ideological Extremity and Issue Ownership" ) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position="none",
        legend.title = element_blank()) +
  scale_color_viridis_d() +
  geom_vline(xintercept = 0, size = .2, linetype = "dashed") +
  guides(color=guide_legend(nrow=1,byrow=TRUE))
```

## H3 Interaction Effect of Ideological Extremity with Journalistic Control on Negative Appeals
```{r "h3", fig.align="center", fig.height=8, fig.width=8}
h3_1 <- run_specs(df = df,
                  y = c("negative_appeals"), 
                  x = c("ie1","ie2","ie3","ie4","ie5","ie6",
                                  "ie7","ie8"),
                  controls = c("polls1","polls2","polls3","polls4",
                                  "polls5","polls6","polls7","polls8",
                                  "polls9",
                                  "io1","io2","io3","io4"),
                      model = "glmer_mv",
                  subsets = list(group1 = unique(df$group1))) 

h3_2 <- run_specs(df = df,
                  y = c("negative_appeals"), 
                  x = c("ie1","ie2","ie3","ie4","ie5","ie6",
                                  "ie7","ie8"),
                  controls = c("polls1","polls2","polls3","polls4",
                                  "polls5","polls6","polls7","polls8",
                                  "polls9",
                                  "io1","io2","io3","io4"),
                  model = "glmer_mv",
                  subsets = list(group1 = unique(df$group2))) 

h3_3 <- run_specs(df = df,
                  y = c("negative_appeals"),
                  x = c("ie1","ie2","ie3","ie4","ie5","ie6",
                                  "ie7","ie8"),
                  controls = c("polls1","polls2","polls3","polls4",
                                  "polls5","polls6","polls7","polls8",
                                  "polls9",
                                  "io1","io2","io3","io4"),
                  model = "glmer_mv",
                  subsets = list(group1 = unique(df$group3))) 


h3_1 <- h3_1 %>% 
  mutate(id = "Daily Average",
         id2 = 1:dim(h3_1)[1]) %>%
  filter(subsets != "all")
h3_2 <- h3_2 %>% 
  mutate(id = "Daily Sum ",
         id2 = 1:dim(h3_2)[1]) %>%
  filter(subsets != "all")
h3_3 <- h3_3 %>% 
  mutate(id = "Deviation from Daily Average",
         id2 = 1:dim(h3_3)[1]) %>%
  filter(subsets != "all")

h3 <- h3_1 %>% 
  add_row(h3_2) %>% 
  add_row(h3_3) %>%
  mutate(subsets = recode(subsets,
                          `group1 = 0` = "Journalistic Intervention: Low",
                          `group1 = 1` = "Journalistic Intervention: Medium",
                          `group1 = 2` = "Journalistic Intervention: High"),
         subsets = factor(subsets,
                          levels = c("Journalistic Intervention: Low", "Journalistic Intervention: Medium", "Journalistic Intervention: High")))

h3 %>%  
  ggplot(aes(y = reorder(id2, estimate),
             x = estimate,
             group = subsets,
             colour = subsets,
             xmin = conf.low,
             xmax = conf.high)) +
  geom_point() + geom_errorbar() +
  facet_grid(id~subsets, scales = "free") +
  labs(y = "", x = "Estimates of Generalized Linear Mixed-Effects Poisson Model",
       title = "Effect of Ideologically Extremity on # Negative Appeals",
       subtitle = "Controlled for Standing in the Polls and Issue Ownership" ) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position="none",
        legend.title = element_blank()) +
  scale_color_viridis_d() +
  geom_vline(xintercept = 0, size = .2, linetype = "dashed") +
  guides(color=guide_legend(nrow=1,byrow=TRUE))
```

## H4 Interaction Effect of Issue Ownership with Journalistic Control on Negative Appeals
```{r "h4", fig.align="center", fig.height=8, fig.width=8}
h4_1 <- run_specs(df = df,
                  y = c("negative_appeals"),
                  x = c("io1","io2","io3","io4"),
                  controls = c("polls1", "polls2", "polls3", "polls4",
                               "ie1","ie2","ie3","ie4","ie5","ie6",
                                  "ie7","ie8"),
                  model = "glmer_mv",
                  subsets = list(group1 = unique(df$group1))) 

h4_2 <- run_specs(df = df,
                  y = c("negative_appeals"),
                  x = c("io1","io2","io3","io4"),
                  controls = c("polls1", "polls2", "polls3", "polls4",
                               "ie1","ie2","ie3","ie4","ie5","ie6",
                                  "ie7","ie8"),                  
                  model = "glmer_mv",
                  subsets = list(group1 = unique(df$group2))) 

h4_3 <- run_specs(df = df,
                  y = c("negative_appeals"),
                  x = c("io1","io2","io3","io4"),
                  controls = c("polls1", "polls2", "polls3", "polls4",
                               "ie1","ie2","ie3","ie4","ie5","ie6",
                                  "ie7","ie8"),
                      model = "glmer_mv",
                     subsets = list(group1 = unique(df$group3))) 

h4_1 <- h4_1 %>% 
  mutate(id = "Daily Average",
         id2 = 1:dim(h4_1)[1]) %>%
  filter(subsets != "all")
h4_2 <- h4_2 %>% 
  mutate(id = "Daily Sum ",
         id2 = 1:dim(h4_2)[1]) %>%
  filter(subsets != "all")
h4_3 <- h4_3 %>% 
  mutate(id = "Deviation from Daily Average",
         id2 = 1:dim(h4_3)[1]) %>%
  filter(subsets != "all")

h4 <- h4_1 %>% 
  add_row(h4_2) %>% 
  add_row(h4_3) %>%
  mutate(subsets = recode(subsets,
                          `group1 = 0` = "Journalistic Intervention: Low",
                          `group1 = 1` = "Journalistic Intervention: Medium",
                          `group1 = 2` = "Journalistic Intervention: High"),
         subsets = factor(subsets,
                          levels = c("Journalistic Intervention: Low", "Journalistic Intervention: Medium", "Journalistic Intervention: High")))

h4 %>%  
  ggplot(aes(y = reorder(id2, estimate),
             x = estimate,
             group = subsets,
             colour = subsets,
             xmin = conf.low,
             xmax = conf.high)) +
  geom_point() + geom_errorbar() +
  facet_grid(id~subsets, scales = "free") +
  labs(y = "", x = "Estimates of Generalized Linear Mixed-Effects Poisson Model",
       title = "Effect of Issue Ownership  on # Negative Appeals",
       subtitle = "Controlled for Standing in the Polls and Issue Ownership" ) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position="none",
        legend.title = element_blank()) +
  scale_color_viridis_d() +
  geom_vline(xintercept = 0, size = .2, linetype = "dashed") +
  guides(color=guide_legend(nrow=1,byrow=TRUE))
```


